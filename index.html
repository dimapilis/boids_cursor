<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boids Flocking Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            height: 100vh;
        }
        
        canvas {
            display: block;
            cursor: crosshair;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 250px;
        }
        
        .info-panel h1 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #4fc3f7;
            text-align: center;
        }
        
        .info-panel p {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .controls {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .control-group label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .control-group input[type="range"] {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            text-align: right;
        }
        
        .stats div {
            margin-bottom: 5px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4fc3f7;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h1>ðŸ¦… Boids Simulation</h1>
        <p>30 birds flocking using Craig Reynolds' algorithm</p>
        <p>Three rules: Separation, Alignment, Cohesion</p>
        
        <div class="controls">
            <div class="control-group">
                <label>Separation:</label>
                <input type="range" id="separation" min="0.5" max="3" step="0.1" value="1.5">
            </div>
            <div class="control-group">
                <label>Alignment:</label>
                <input type="range" id="alignment" min="0.5" max="3" step="0.1" value="1.0">
            </div>
            <div class="control-group">
                <label>Cohesion:</label>
                <input type="range" id="cohesion" min="0.5" max="3" step="0.1" value="1.0">
            </div>
            <div class="control-group">
                <label>Speed:</label>
                <input type="range" id="speed" min="0.5" max="2" step="0.1" value="1.0">
            </div>
        </div>
    </div>
    
    <div class="stats">
        <div>FPS: <span id="fps">0</span></div>
        <div>Birds: <span id="birdCount">0</span></div>
        <div>Avg Speed: <span id="avgSpeed">0</span></div>
    </div>
    
    <div class="loading" id="loading">Loading simulation...</div>
    
    <canvas id="canvas"></canvas>
    
    <script>
        class BoidsSimulation {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.boids = [];
                this.lastTime = 0;
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                this.setupControls();
                this.animate();
            }
            
            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
            
            setupControls() {
                const controls = ['separation', 'alignment', 'cohesion', 'speed'];
                controls.forEach(control => {
                    const slider = document.getElementById(control);
                    slider.addEventListener('input', (e) => {
                        this.updateParameter(control, parseFloat(e.target.value));
                    });
                });
            }
            
            updateParameter(param, value) {
                // This would be sent to the C++ backend
                console.log(`${param}: ${value}`);
            }
            
            drawBoid(x, y, vx, vy) {
                const angle = Math.atan2(vy, vx);
                const speed = Math.sqrt(vx * vx + vy * vy);
                
                this.ctx.save();
                this.ctx.translate(x, y);
                this.ctx.rotate(angle);
                
                // Make birds larger and more visible
                const scale = 2.0;
                this.ctx.scale(scale, scale);
                
                // Bird body (aerodynamic triangle)
                this.ctx.fillStyle = '#4fc3f7';
                this.ctx.beginPath();
                this.ctx.moveTo(10, 0);
                this.ctx.lineTo(-5, -4);
                this.ctx.lineTo(-5, 4);
                this.ctx.closePath();
                this.ctx.fill();
                
                // Bird wing (dynamic shape)
                this.ctx.fillStyle = '#29b6f6';
                this.ctx.beginPath();
                this.ctx.moveTo(0, 0);
                this.ctx.lineTo(-3, -8);
                this.ctx.lineTo(3, -6);
                this.ctx.closePath();
                this.ctx.fill();
                
                // Bird tail (small triangle)
                this.ctx.fillStyle = '#0277bd';
                this.ctx.beginPath();
                this.ctx.moveTo(-5, 0);
                this.ctx.lineTo(-10, -3);
                this.ctx.lineTo(-10, 3);
                this.ctx.closePath();
                this.ctx.fill();
                
                // Bird eye (small dot)
                this.ctx.fillStyle = '#000';
                this.ctx.beginPath();
                this.ctx.arc(6, -1, 1, 0, 2 * Math.PI);
                this.ctx.fill();
                
                this.ctx.restore();
                
                // Add a small glow effect
                this.ctx.save();
                this.ctx.globalAlpha = 0.3;
                this.ctx.fillStyle = '#4fc3f7';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 8, 0, 2 * Math.PI);
                this.ctx.fill();
                this.ctx.restore();
            }
            
            updateStats() {
                const now = performance.now();
                this.frameCount++;
                
                if (now - this.lastFpsUpdate >= 1000) {
                    this.fps = Math.round(this.frameCount * 1000 / (now - this.lastFpsUpdate));
                    this.frameCount = 0;
                    this.lastFpsUpdate = now;
                    
                    document.getElementById('fps').textContent = this.fps;
                    document.getElementById('birdCount').textContent = this.boids.length;
                    
                    if (this.boids.length > 0) {
                        const avgSpeed = this.boids.reduce((sum, boid) => {
                            return sum + Math.sqrt(boid.vx * boid.vx + boid.vy * boid.vy);
                        }, 0) / this.boids.length;
                        document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
                    }
                }
            }
            
            animate(currentTime = 0) {
                const deltaTime = currentTime - this.lastTime;
                this.lastTime = currentTime;
                
                // Create subtle trail effect - make it less aggressive
                this.ctx.fillStyle = 'rgba(26, 26, 46, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw boids
                this.boids.forEach(boid => {
                    this.drawBoid(boid.x, boid.y, boid.vx, boid.vy);
                });
                
                this.updateStats();
                requestAnimationFrame((time) => this.animate(time));
            }
            
            updateBoids(newBoids) {
                this.boids = newBoids;
                document.getElementById('loading').style.display = 'none';
                console.log(`Updated boids: ${newBoids.length} birds`);
            }
        }
        
        // Initialize simulation
        const simulation = new BoidsSimulation();
        
        // Fetch boids data from C++ server
        function fetchBoids() {
            fetch('/api/boids')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.boids && data.boids.length > 0) {
                        simulation.updateBoids(data.boids);
                        console.log(`Updated ${data.boids.length} boids from server`);
                    } else {
                        throw new Error('Invalid data received');
                    }
                })
                .catch(error => {
                    console.error('Error fetching boids:', error);
                    // Fallback to local simulation if server is not available
                    generateLocalBoids();
                });
        }
        
        // Fallback local simulation
        function generateLocalBoids() {
            const boids = [];
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            for (let i = 0; i < 30; i++) {
                const angle = (i / 30) * 2 * Math.PI + Date.now() * 0.001;
                const radius = 100 + Math.sin(Date.now() * 0.002 + i) * 50;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                const speed = 2 + Math.random() * 2;
                const vx = Math.cos(angle + Math.PI/2) * speed;
                const vy = Math.sin(angle + Math.PI/2) * speed;
                
                boids.push({ x, y, vx, vy });
            }
            console.log('Generated local boids:', boids.length);
            simulation.updateBoids(boids);
        }
        
        // Update boids every 50ms
        setInterval(fetchBoids, 50);
    </script>
</body>
</html> 